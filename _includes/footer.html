{% include svg-icons.html %}

{% if site.footer-text %}
<p>{{ site.footer-text }}</p>
{% endif %}

<!-- 主题切换按钮 -->
<div class="theme-toggle" id="themeToggle">
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24">
    <path id="themeIcon" d="M12,18c-3.3,0-6-2.7-6-6s2.7-6,6-6s6,2.7,6,6S15.3,18,12,18zM12,8c-2.2,0-4,1.8-4,4s1.8,4,4,4s4-1.8,4-4S14.2,8,12,8z M12,2 c-5.5,0-10,4.5-10,10s4.5,10,10,10s10-4.5,10-10S17.5,2,12,2z"/>
  </svg>
</div>

<script>
const ThemeManager = {
  init() {
    const themeToggle = document.getElementById('themeToggle');
    const themeIcon = document.getElementById('themeIcon');
    const body = document.body;

    if (!themeToggle) {
      console.error('未找到themeToggle元素');
      return;
    }
    if (!themeIcon) {
      console.error('未找到themeIcon元素');
      return;
    }

    themeToggle.removeEventListener('click', this.toggleTheme.bind(this));
    themeToggle.addEventListener('click', this.toggleTheme.bind(this));
    console.log('主题切换事件已绑定');

    window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
      console.log('系统主题变化:', e.matches ? '深色' : '浅色');
      this.initTheme();
    });

    this.initTheme();
  },

  initTheme() {
    try {
      const savedTheme = localStorage.getItem('theme');
      const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
      
      console.log('初始化主题 - 保存的主题:', savedTheme, '系统偏好:', prefersDark);
      
      const isDark = (!savedTheme && prefersDark) || savedTheme === 'dark';
      if (isDark) {
        document.body.classList.add('dark-mode');
        this.updateIcon(true);
      } else {
        document.body.classList.remove('dark-mode');
        this.updateIcon(false);
      }
    } catch (e) {
      console.error('初始化主题失败:', e);
    }
  },

  updateIcon(isDark) {
    try {
      const darkPath = "M12,15.5A3.5,3.5 0 0,1 8.5,12A3.5,3.5 0 0,1 12,8.5A3.5,3.5 0 0,1 15.5,12A3.5,3.5 0 0,1 12,15.5M12,3A9,9 0 0,0 3,12A9,9 0 0,0 12,21A9,9 0 0,0 21,12A9,9 0 0,0 12,3M12,19A7,7 0 0,1 5,12A7,7 0 0,1 12,5A7,7 0 0,1 19,12A7,7 0 0,1 12,19Z";
      const lightPath = "M12,18c-3.3,0-6-2.7-6-6s2.7-6,6-6s6,2.7,6,6S15.3,18,12,18zM12,8c-2.2,0-4,1.8-4,4s1.8,4,4,4s4-1.8,4-4S14.2,8,12,8z M12,2 c-5.5,0-10,4.5-10,10s4.5,10,10,10s10-4.5,10-10S17.5,2,12,2z";
      
      document.getElementById('themeIcon').setAttribute('d', isDark ? darkPath : lightPath);
      console.log('图标已更新为', isDark ? '深色' : '浅色');
    } catch (e) {
      console.error('更新图标失败:', e);
    }
  },

  toggleTheme() {
    try {
      const isDark = document.body.classList.toggle('dark-mode');
      localStorage.setItem('theme', isDark ? 'dark' : 'light');
      this.updateIcon(isDark);
      console.log('主题已切换为', isDark ? '深色' : '浅色');
    } catch (e) {
      console.error('切换主题失败:', e);
    }
  }
};

if (window.addEventListener) {
  window.addEventListener('load', () => ThemeManager.init());
} else if (window.attachEvent) {
  window.attachEvent('onload', () => ThemeManager.init());
}
</script>